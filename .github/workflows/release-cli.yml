name: Release CLI

on:
  push:
    tags:
      - 'cli-v*'  # Trigger on CLI version tags (e.g., cli-v0.1.0)

permissions:
  contents: write

jobs:
  code-checks:
    name: CLI Code Checks
    uses: ./.github/workflows/code-quality-cli.yml

  build-and-release:
    name: Build and release CLI to GitHub
    runs-on: ubuntu-latest
    needs: code-checks

    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Install uv
        uses: astral-sh/setup-uv@61cb8a9741eeb8a550a1b8544337180c0fc8476b # v7.2.0
        with:
          enable-cache: true
          python-version: '3.13'

      - name: Extract version from tag
        id: get_version
        run: |
          # Extract version from tag or release
          if [[ "${{ github.event_name }}" == "release" ]]; then
            # Release event: extract from release tag (e.g., cli-v0.1.0 -> 0.1.0)
            TAG_NAME="${{ github.event.release.tag_name }}"
          else
            # Tag push event: extract from ref (e.g., refs/tags/cli-v0.1.0 -> cli-v0.1.0)
            TAG_NAME="${GITHUB_REF#refs/tags/}"
          fi
          
          # Remove cli-v prefix if present
          if [[ "$TAG_NAME" =~ ^cli-v(.+)$ ]]; then
            VERSION="${BASH_REMATCH[1]}"
          else
            echo "::error::Tag name must start with 'cli-v' (e.g., cli-v0.1.0), got: $TAG_NAME"
            exit 1
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "CLI Version: $VERSION"

      - name: Validate version format
        id: validate_version
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          # Validate PEP 440 version format (Python packaging standard)
          # Supports: 1.0.0, 1.0.0a1, 1.0.0b1, 1.0.0rc1, 1.0.0.dev1, 1.0.0.post1
          PEP440_REGEX='^([0-9]+)\.([0-9]+)\.([0-9]+)(a[0-9]+|b[0-9]+|rc[0-9]+)?(\.dev[0-9]+)?(\.post[0-9]+)?(\+[a-zA-Z0-9\.]+)?$'
          if [[ ! "$VERSION" =~ $PEP440_REGEX ]]; then
            echo "::error::Invalid version format: '$VERSION'. Must be PEP 440 compliant (e.g., 1.0.0, 1.0.0a1, 1.0.0b1, 1.0.0rc1, 1.0.0.dev1)"
            exit 1
          fi
          echo "Version '$VERSION' is valid PEP 440"

          # Consider .post releases as stable (not prerelease)
          RELEASE_REGEX='^[0-9]+\.[0-9]+\.[0-9]+(\.post[0-9]+)?$'
          if [[ "$VERSION" =~ $RELEASE_REGEX ]]; then
            echo "prerelease=false" >> $GITHUB_OUTPUT
          else
            echo "prerelease=true" >> $GITHUB_OUTPUT
          fi

      - name: Build package
        working-directory: cli
        env:
          SETUPTOOLS_SCM_PRETEND_VERSION: ${{ steps.get_version.outputs.version }}
        run: |
          uv sync --frozen
          uv build

      - name: Verify package contents
        working-directory: cli
        run: |
          ls -lh dist/
          uv run --with twine twine check dist/*

      - name: Create or Update GitHub Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        with:
          tag_name: ${{ github.event.release.tag_name || github.ref_name }}
          files: |
            cli/dist/*.whl
            cli/dist/*.tar.gz
          body: |
            ## mcp-tef CLI ${{ steps.get_version.outputs.version }}

            ### Installation

            Install from Git repository:

            ```bash
            uv tool install "mcp-tef-cli @ git+https://github.com/${{ github.repository }}.git@cli-v${{ steps.get_version.outputs.version }}#subdirectory=cli"
            ```

            ### Quick Start

            ```bash
            # Deploy latest mcp-tef server
            mtef deploy

            # Deploy with API keys
            mtef deploy \
              --env OPENROUTER_API_KEY=sk-xxx \
              --health-check
            ```

            ### Documentation

            See the [CLI README](https://github.com/${{ github.repository }}/tree/main/cli) for full documentation.
          draft: false
          prerelease: ${{ steps.validate_version.outputs.prerelease == 'true' }}
          generate_release_notes: true
